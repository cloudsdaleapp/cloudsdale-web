window.Cloud = class Cloud
  
  constructor: (args) ->
    
    @cloud_id = args.cloud_id
    @room_name = args.room_name
    @room_id = args.room_id
    @room_topic = args.room_topic
    @parent_frame = args.parent_frame
    @parent = args.parent
    
    @frame = $(".cloud-container[data-room-id=#{@room_id}]")
    @handler = $(".cloud-trigger[data-room-id=#{@room_id}]")
    
    @faye = args.faye
    @seeded = false
    @active = false
    @last_sender_uid = ""
    @title_notifications = 0
    
    console.log  $.cookie("cloud:#{@room_id}:contracted")
    if $.cookie("cloud:#{@room_id}:contracted") == null or $.cookie("cloud:#{@room_id}:contracted") == "true"
      @frame.addClass('contracted')
      $.cookie "cloud:#{@room_id}:contracted", true,
        expires: 365
        path: "/"
    else
      @frame.removeClass('contracted')
      @updateOnlineList()
    
    @config()
    @render()
    
  config: =>
    @conf_MaxMessages = 50
    
  render: =>
    @setup()
    @bind()
    @finalize()
      
  setup: =>
    # Sets up hooks to all the elements associated with chat room.
    @trigger = @handler.find("a")
    @notification_plate = @handler.find("span.cloud-notification")
    @toolbar = @frame.find(".cloud-toolbar")
    @close_trigger = @toolbar.find("header a.closex")
    @contract_trigger = @toolbar.find("header a.contract")
    @online_user_counter = @toolbar.find("header span.usercount")
    
    @extrasWrapper = @frame.find(".cloud-extras-wrapper")
    @userList = @extrasWrapper.find("ul.cloud-users-list")
    
    @container = @frame
    @wrapper = @frame.find(".cloud-chat-messages")
    @form = @frame.find("form")
    @input = @form.find("textarea")


  bind: =>
    # Binds certain chat room frame interaction events
    @trigger.bind "click", =>
      $.event.trigger 'toggle.cloud', @
      false
    
    @close_trigger.bind "click", =>
      $.event.trigger 'toggle.cloud', @
      false
    
    @trigger.bind "toggle.cloud", (e,obj) =>
      if obj == @
        @toggle()
      else
        if @active
          @hide()
    
    @contract_trigger.bind 'click', (e) =>
      @toggleContraction()
    
    @input.BetterGrow
      initial_height: 12
      do_not_enter: null

    .keydown (e) =>
      @resizeElements()
      if e.which == 13 and e.shiftKey == false
        @form.submit()
        false

    @form.bind 'ajax:beforeSend', () =>
      @appendMessage(Date.now().toString(),@parseMessageContent(@input.val()),@parent.user_name,@parent.user_path,@parent.user_avatar,@parent.uid)
      @resetInput()
    .submit () =>
      @validateInput()
    
    # Set up subscription to room's message broadcast channel
    @faye.subscribe "/chat/room/#{@room_id}", (data) =>
      @addNotification()
      if @seeded and @parent.uid != data.uid
        @appendMessage(data.timestamp,data.content,data.user_name,data.user_path,data.user_avatar,data.uid)
    
    $(window).bind 'focus', =>
      if @active
        @clearNotifications()
  
  finalize: =>
    # Prepare the frames for interaction.
    @setNotifications()
    if $.cookie "cloud:active:#{@room_id}"
      @show()
    else
      @hide()
  
  toggle: ->
    if @active
      @hide()
    else
      @show()
  
  toggleContraction: ->
    if $.cookie("cloud:#{@room_id}:contracted") == "true"
      @frame.removeClass('contracted')
      $.cookie "cloud:#{@room_id}:contracted", false,
        expires: 365
        path: "/"
    else
      @frame.addClass('contracted')
      $.cookie "cloud:#{@room_id}:contracted", true,
        expires: 365
        path: "/"
        
  show: ->
    # Takes the chat frame to maximized mode.
    $.cookie "cloud:active:#{@room_id}", true,
      expires: 365
      path: "/"
      
    @active = true
    @frame.addClass('active')
    @handler.addClass('active')
    @seed()
    @correctContainerScroll(true)
    @clearNotifications()
    
  hide: ->
    # Takes the chat frame into minimized mode.
    $.cookie "cloud:active:#{@room_id}", null,
      expires: 365
      path: "/"
      
    @active = false
    @frame.removeClass('active')
    @handler.removeClass('active')
    
  seed: ->
    # Appends last 30 messages from designated chat room into the container.
    unless @seeded
      $.getJSON "/chat/rooms/#{@room_id}/messages", (data) =>
        i = data.length - 1
        $.each data, (key, val) =>
          @appendMessage(val.timestamp,val.content,val.user_name,val.user_path,val.user_avatar,val.author_id)
          @correctContainerScroll(true)
          if key == i
            window.setTimeout ( =>
              @correctContainerScroll(true)
            ), 500
            
        @seeded = true
  
  parseMessageContent: (c) ->
    c = c.replace(/<\/?[^>]*>/gi,"")
    c = c.replace(/\n/gi,"<br />")
    c = c.replace(/<br\/><br\/>/gi,"<br/>")
    c = c.replace(/^\s*$/gi,"")
    
    c = c.replace /([a-z]{1,6}\:\/\/)([a-z0-9\.\,\-\_\:]*)(\/?[a-z0-9\'\"\.\,\-\_\/\?\:\&\=\#\%\+\(\)]*)/gi, (match,protocol,top_dom,path) ->
      console.log 
      pjax_data = if top_dom.match(/cloudsdale.org/i) == null then "target='_blank' data-skip-pjax='true'" else ""
      "<a class='chat-link' href='#{match}' #{pjax_data}>#{match}</a>"
    return c
    
  appendMessage: (timestamp,content,user_name,user_path,user_avatar,uid) =>
    # Appends a message to the bottom of the message container.
    t = new Date(timestamp)
    image = if user_avatar then "src='#{user_avatar}'" else "src='#{@parent.default_avatar_src}'"
    if uid == @last_sender_uid
      @last_message_frame.append("<p>#{content}</p>")
    else
      @last_message_frame = @wrapper.append("<div data-timestamp='#{timestamp}'class='chat-message'>
          <a href='#{user_path}'><img #{image}/></a>
          <header class='chat-message-head'>
            <span class='sender'><a href='#{user_path}'>#{user_name}</a></span>
            <span class='metadata'>#{t.toString('HH:mm:ss')}</span>
          </header>
          <article class='chat-message-content'>
            <p >#{content}</p>
          </article>
        </div>").find('div.chat-message:last article')
      @last_sender_uid = uid
    
    @popLastMessages()
    @correctContainerScroll(true)
    
  popLastMessages: ->
    if @wrapper.children('div.chat-message').size() > @conf_MaxMessages
      @wrapper.find('div.chat-message:first').remove()
    
  isReadingHistory: ->
    # Should return true if scroll frame is not at maximum scroll down.
    (@container[0].scrollHeight - @container.scrollTop() == @container.outerHeight())

  correctContainerScroll: (readyForCorrection) ->
    # Scrolls chat container down to the bottom if readForCorrection is true.
    if readyForCorrection
      @wrapper.scrollTop(@wrapper[0].scrollHeight)
  
  resizeElements: ->
    window.setTimeout ( =>
      resizeHeight = @input.outerHeight() + 9
      @wrapper.css
        bottom: resizeHeight
      @correctContainerScroll(true)
    ), 110
  
  validateInput: ->
    # Validates the input client side to ease load on chat servers.
    if (@input.attr('value').match(/^\s*$/) == null) and (@input.val.length > 0)
      true
    else
      false

  resetInput: ->
    # Resets the chat input completly.
    @input.val('')
  
  refreshGraphics: ->
    if @notifications > 0
      @notification_plate.html("#{@notifications}")
      @notification_plate.show()
    else
      @notification_plate.html("")
      @notification_plate.hide()

  clearNotifications: ->
    @parent.subtractGlobalNotification(@notifications)
    $.cookie "chatroom:notifications:#{@room_id}", 0, 
      expires: 365
      path: "/"
    @notifications = 0
    @refreshGraphics()
    
  addNotification: ->
    @notifications += 1
    unless @active
      $.cookie "chatroom:notifications:#{@room_id}", @notifications, 
        expires: 365
        path: "/"
        @refreshGraphics()
        
    @parent.addGlobalNotification()
    
      
  setNotifications: ->
    n = $.cookie "chatroom:notifications:#{@room_id}"
    unless n == null or n == NaN
      @notifications = parseInt($.cookie("chatroom:notifications:#{@room_id}"))
    else
      @notifications = 0
      $.cookie "chatroom:notifications:#{@room_id}", @notifications, 
        expires: 365
        path: "/"
        
    @refreshGraphics()
  
  updateOnlineList: =>
    $.PeriodicalUpdater "/clouds/#{@cloud_id}/members",
      method: "get"
      dataType: "json"
      minTimeout: 30000
      maxTimeout: 60000
      success: (result) =>
        @online_user_counter.html("#{result.length}")
        @userList.html("")
        if $.cookie("cloud:#{@room_id}:contracted") == "false"
          $.each result, (k,v) =>
            user = $.parseJSON(v)
            image = if user.avatar_versions then "src='#{user.avatar_versions.mini}'" else "src='#{@parent.default_avatar_src}'"
            @userList.append("<li><a href='/users/#{user.id}'><img #{image}'></img>#{user.name}</a></li>")
            
            


window.BottomBar = class BottomBar
  
  constructor: (args) ->
    @n = 0
    @container = $(".cloud-list")
    @faye = new Faye.Client("<%=Cloudsdale.config['url']%>:9191/faye")
    @uid = @container.data('uid')
    @user_name = @container.data('user_name')
    @user_avatar = @container.data('user_avatar')
    @user_path = @container.data('user_path')
    @getRooms()
    
    @default_avatar_src = $("#img_unknown_pony_chat").attr('src')
    
  getRooms: () ->
    $.each $(@container.children()), (key, val) =>
      data = $(val).data()
      new Cloud
        cloud_id: data.cloudId
        room_id: data.roomId
        room_name: data.roomName
        room_topic: data.roomTopic
        faye: @faye
        parent_frame: @container
        parent: @
  
  clearGlobalNotification: ->
    @n = 0
  
  addGlobalNotification: ->
    @n += 1
    @setGlobalNotification()
    
  subtractGlobalNotification: (num) ->
    @n -= num
    if @n < 0
      @clearGlobalNotification()
    @setGlobalNotification()
    
  setGlobalNotification: ->
    $.titleAlert "(#{@n}) message(s)",
      requireBlur: true
      stopOnFocus: true
      duration: 0
      interval: 1500
