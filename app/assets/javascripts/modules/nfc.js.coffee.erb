do ($ = jQuery) ->
  
  window.globalNotifications = 0
  
  window.clearGlobalNotification = ->
    window.globalNotifications = 0
  
  window.addGlobalNotification = (num) ->
    window.globalNotifications += num
    window.setGlobalNotification()
  
  window.subtractGlobalNotification = (num) ->
    window.globalNotifications -= num
    if window.lobalNotifications < 0
      window.clearGlobalNotification()
    window.setGlobalNotification()
  
  window.setGlobalNotification = ->
    $.titleAlert "(#{window.globalNotifications}) new event(s)",
      requireBlur: true
      stopOnFocus: true
      duration: 0
      interval: 1500
  
  window.NotificationCentre = class NotificationCentre
  
    constructor: (args) ->
      @cli = new Faye.Client("<%=Cloudsdale.faye_path(:client)%>", { timeout: 120 })
      subscription = @cli.subscribe('/')
      
      subscription.callback =>
        if @cli.getState() == 'CONNECTED'
          $.event.trigger "connected:nfc"

      subscription.errback =>
        if @cli.getState() == 'CONNECTED'
          $.event.trigger "connected:nfc"
    
    state: ->
      @cli.getState()
    
    # Use this to start listening to a specific channel
    on: (event,f) ->
      
      channel = "/#{event.replace(/\:/ig,"/")}" # The event name translated to Faye channel
                  
      if @cli._channels._channels[channel] == undefined
        subscription = @cli.subscribe channel, (payload) ->
          $.event.trigger "#{event}", payload
      
      $(document).bind "#{event}", (event,payload) ->
        f(payload)
        
      this
    
    # Use this to simulate an incomming payload
    t: (event,data) -> $.event.trigger "#{event}", data